<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>The Strategic Owl | Truth. Reliability. Understanding.</title>

  <!-- Open Graph Meta (Facebook, LinkedIn, Discord, etc.) -->
  <meta property="og:title" content="The Strategic Owl | Truth. Reliability. Understanding." />
  <meta property="og:description" content="Measure credibility and uncover truth using the TRU OWL Score ‚Äî a tool for independent thinkers." />
  <meta property="og:image" content="https://thestrategicowl.com/STOInsightQuiz.png" />
  <meta property="og:image:type" content="image/png" />
  <meta property="og:image:width" content="1200" />
  <meta property="og:image:height" content="630" />
  <meta property="og:url" content="https://thestrategicowl.com" />
  <meta property="og:type" content="website" />

  <!-- Twitter Card Meta -->
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="The Strategic Owl | Truth. Reliability. Understanding." />
  <meta name="twitter:description" content="Measure credibility and uncover truth using the TRU OWL Score ‚Äî a tool for independent thinkers." />
  <meta name="twitter:image" content="https://thestrategicowl.com/TSO.png" />

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&family=Playfair+Display:wght@600;700&display=swap" rel="stylesheet" />

  <style>
  :root {
    --background: #0D1B2A;
    --surface: #112240;
    --highlight: #1A2B4C;
    --truth: #28A745;
    --reliability: #3B6CED;
    --understanding: #D4AF37;
    --text: #FFFFFF;
    --text-muted: #7C8A9B;
    --heading: #FFFFF0;
    --shadow: rgba(0, 0, 0, 0.3);
    --bar-red: #FF4C4C;
    --bar-green: #28A745;
  }

  body {
    background-color: var(--background);
    color: var(--text);
    font-family: 'Inter', sans-serif;
    margin: 0;
    padding: 0;
  }

  /* üß≠ NAVBAR & MENU */
  nav.top-nav {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    z-index: 999;
    background-color: var(--highlight);
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 14px 20px;
    box-shadow: 0 2px 6px var(--shadow);
  }

  .nav-title {
    font-family: 'Playfair Display', serif;
    font-size: 22px;
    color: var(--understanding);
  }

  .menu-toggle {
    display: none;
    font-size: 24px;
    cursor: pointer;
    color: var(--text);
    background: none;
    border: none;
  }

  .nav-links {
    display: flex;
    gap: 28px;
  }

  .nav-links a {
    color: var(--text-muted);
    text-decoration: none;
    font-size: 15px;
    transition: color 0.3s ease;
  }

  .nav-links a:hover {
    color: var(--understanding);
  }
    .nav-logo img {
  height: 40px;
  width: 40px;
}
    .nav-logo {
  display: flex;
  align-items: center;
  gap: 10px;
  text-decoration: none;
  font-weight: 600;
  color: var(--text);
  font-size: 1.25rem;
}
    /* üé® TRU Bars */
  .divider-section {
    display: flex;
    flex-direction: column;
    align-items: center;
    margin: 40px auto;
  }

  .divider-bar {
    display: flex;
    gap: 12px;
    width: 340px;
  }

  .divider-bar div {
    width: 108px;
    height: 6px;
    border-radius: 3px;
    box-shadow: 0 0 4px var(--shadow);
  }

  .truth { background-color: var(--truth); }
  .reliability { background-color: var(--reliability); }
  .understanding { background-color: var(--understanding); }

  .divider-labels {
    display: flex;
    justify-content: center;
    gap: 12px;
    width: 340px;
    margin-top: 8px;
  }

  .divider-labels span {
    width: 108px;
    text-align: center;
    font-size: 0.85rem;
    color: var(--text-muted);
  }

  @media (max-width: 768px) {
  .menu-toggle {
    display: block;
  }

  .nav-links {
    display: none;
    flex-direction: column; /* ‚úÖ stack vertically */
    align-items: center;
    background-color: var(--highlight);
    position: absolute;
    top: 58px;
    left: 0;
    width: 100%;
    padding: 12px 0;
    gap: 12px;
    box-shadow: 0 3px 8px var(--shadow);
  }

  .nav-links.show {
    display: flex;
    animation: fadeSlideDown 0.3s ease;
  }

  .nav-links a {
    padding: 10px 0;
    width: 100%;
    text-align: center;
    font-size: 1rem;
  }

  @keyframes fadeSlideDown {
    from {
      opacity: 0;
      transform: translateY(-10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
}
    #legal-popup {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(13, 27, 42, 0.95);
  z-index: 9999;
  overflow-y: auto;
  padding: 40px 20px;
  box-sizing: border-box;
  display: none;
}

#legal-popup > div {
  max-width: 680px;
  width: 100%;
  margin: 0 auto;
  background-color: var(--surface);
  padding: 30px;
  border-radius: 8px;
  box-shadow: 0 0 20px var(--shadow);
  font-family: 'Montserrat', sans-serif;
  color: var(--text);
  line-height: 1.6;
}

@media (max-width: 500px) {
  #legal-popup > div {
    padding: 16px 12px;
    font-size: 0.95rem;
  }

  .important-link {
    display: block;
    text-align: center;
    margin-top: 16px;
  }
}

  /* ‚úÖ YOUR ORIGINAL STYLES BELOW */
  .container {
    max-width: 960px;
    margin: 100px auto 0 auto;
    padding: 24px;
  }

  h1 {
    font-family: 'Playfair Display', serif;
    color: var(--understanding);
    font-size: 2.6rem;
    font-weight: 700;
    margin-bottom: 16px;
    text-align: center;
  }
  h2 {
  font-family: 'Playfair Display', serif;
  font-size: 1.5rem;
  color: var(--understanding); /* golden highlight */
  font-weight: 600;
  margin-top: 32px;
  margin-bottom: 12px;
  text-align: center;
}
  p {
  font-family: 'Inter', sans-serif;
  font-size: 1.05rem;
  color: var(--text-muted);
  line-height: 1.6;
  margin-bottom: 20px;
  text-align: center;
  max-width: 700px;
  margin-left: auto;
  margin-right: auto;
}

  select {
    padding: 8px;
    margin-bottom: 16px;
    background-color: var(--surface);
    color: var(--text);
    border: 1px solid var(--highlight);
  }

  table {
    width: 100%;
    border-collapse: collapse;
    background-color: var(--surface);
    margin-top: 12px;
  }

  th, td {
    padding: 12px;
    border-bottom: 1px solid var(--highlight);
    text-align: left;
  }

  .text-truth { color: var(--truth); }
  .text-reliability { color: var(--reliability); }
  .text-understanding { color: var(--understanding); }

  .total-score {
    font-weight: bold;
  }

  .positive-score { color: var(--bar-green); }
  .negative-score { color: var(--bar-red); }

  .score-bar {
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .bar-indicator {
    width: 10px;
    height: 24px;
    border-radius: 2px;
  }

  .bar-red {
    background-color: var(--bar-red);
  }

  .bar-green {
    background-color: var(--bar-green);
  }
    .match-nav-link {
  color: var(--text-muted);
  text-decoration: none;
  font-size: 15px;
  transition: color 0.3s ease;
}

.match-nav-link:hover {
  color: var(--understanding);
}
 /* Style the link itself */
.important-link {
  color: var(--understanding);               /* Gold color from your theme */
  font-weight: 700;                          /* Bold for visibility */
  text-decoration: underline;                /* Underline to signal it's a link */
  text-underline-offset: 4px;                /* Adds spacing between text and underline */
  position: relative;                        /* Required for pseudo-elements */
  transition: color 0.3s ease, text-shadow 0.3s ease;  /* Smooth hover transitions */
}

/* Add a right-pointing arrow BEFORE the link text */
.important-link::before {
  content: '‚Üí ';                             /* Arrow pointing right */
  display: inline-block;                     /* So we can animate it */
  margin-right: 6px;                         /* Space between arrow and text */
  transition: transform 0.3s ease;           /* Smooth movement on hover */
}

/* Add a left-pointing arrow AFTER the link text */
.important-link::after {
  content: ' ‚Üê';                             /* Arrow pointing left */
  display: inline-block;                     /* Enables transform */
  margin-left: 6px;                          /* Space between text and arrow */
  transition: transform 0.3s ease;           /* Smooth hover animation */
}

/* Animate the left-side arrow to move right on hover */
.important-link:hover::before {
  transform: translateX(4px);                /* Moves ‚Üí arrow to the right */
}

/* Animate the right-side arrow to move left on hover */
.important-link:hover::after {
  transform: translateX(-4px);               /* Moves ‚Üê arrow to the left */
}

/* Add glow and optional color change on hover */
.important-link:hover {
  text-shadow: 0 0 8px var(--understanding); /* Subtle glow using gold tone */
  color: var(--truth);                       /* Optional: changes to green (truth color) */
}
    /* üì¢ Shared Announcement Box Styles */
.announcement-box {
  background-color: var(--surface);
  padding: 24px;
  border-radius: 12px;
  margin: 24px auto;
  max-width: 960px;
  font-family: 'Inter', sans-serif;
  color: var(--text);
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  text-align: center;
  font-size: 1.1rem;
  line-height: 1.7;
  letter-spacing: 0.1px;
  gap: 10px;
}

.announcement-box-mobile {
  background-color: var(--surface);
  padding: 20px 16px;
  border-radius: 12px;
  margin: 24px auto;
  font-family: 'Inter', sans-serif;
  color: var(--text);
  max-width: 90%;
  font-size: 1.05rem;
  line-height: 1.7;
  text-align: center;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 6px;
}

/* üü¢ Label Color */
.announcement-label {
  color: var(--truth);
  font-weight: 600;
  font-size: 1.1rem;
}

/* üîó Strategic Link Styling */
.important-link {
  color: var(--understanding);
  font-weight: 700;
  text-decoration: underline;
  text-underline-offset: 4px;
  position: relative;
  transition: color 0.3s ease, text-shadow 0.3s ease;
}

.important-link::before {
  content: '‚Üí ';
  display: inline-block;
  margin-right: 6px;
  transition: transform 0.3s ease;
}

.important-link::after {
  content: ' ‚Üê';
  display: inline-block;
  margin-left: 6px;
  transition: transform 0.3s ease;
}

.important-link:hover::before {
  transform: translateX(4px);
}

.important-link:hover::after {
  transform: translateX(-4px);
}

.important-link:hover {
  text-shadow: 0 0 8px var(--understanding);
  color: var(--truth);
}

/* üì± Mobile Layout */
@media (max-width: 768px) {
  .announcement-desktop {
    display: none;
  }

  .announcement-mobile {
    padding: 0;
    text-align: center;
  }

  .announcement-box-mobile .important-link {
    display: inline-block;
    margin: 6px 0;
  }
}

/* üíª Desktop Layout */
@media (min-width: 769px) {
  .announcement-mobile {
    display: none;
  }
}
  /* üìú Footer */
  footer {
    text-align: center;
    padding: 24px 12px;
    font-size: 12px;
    color: #D4AF37;
    text-shadow: 0 0 6px rgba(0, 0, 0, 0.6);
    font-family: 'Inter', sans-serif;
  }
    /* ‚îÄ‚îÄ Voter Dashboard: State Picker (brand-aligned) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
/* ‚îÄ‚îÄ Voter Dashboard: State Picker (brand-aligned) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
/* Center the selected value across browsers */
#state-select {
  display: block;             /* ensures margin centering works */
  width: 100%;
  max-width: 360px;
  margin: 12px auto;
  text-align: center;         /* Safari/iOS */
  text-align-last: center;    /* Chrome/Edge/Firefox */
  appearance: auto;           /* restore native look */
  -webkit-appearance: menulist;
}
#state-select option { text-align: center; }  /* helps Safari/iOS */

/* Output wrapper (hidden by default; JS sets to block) */
.state-output {
  display: none;
  margin-top: 12px;
  width: 100%;
  max-width: 560px;
  margin-left: auto;
  margin-right: auto;
  text-align: center;
}

/* Read-only URL field */
#state-url {
  width: 100%;
  padding: 12px 14px;
  background-color: var(--surface);
  color: var(--text);
  border: 1px solid var(--highlight);
  border-radius: 8px;
  box-shadow: 0 2px 6px var(--shadow);
  font-family: 'Inter', sans-serif;
  font-size: 0.98rem;
  text-align: center;
}
#state-url::selection {
  background: var(--understanding);
  color: #0D1B2A;            /* deep navy for contrast */
}

/* Election date line (from Column C) */
.state-date {
  margin-top: 10px;
  font-family: 'Inter', sans-serif;
  font-size: 0.98rem;
  color: var(--text-muted);
  text-align: center;
}
.state-date .date-label {
  font-weight: 600;
  margin-right: 6px;
}
.state-date .date-value {
  color: var(--understanding);
  font-weight: 700;
}

/* Action row */
.state-actions {
  margin-top: 10px;
  display: flex;
  justify-content: center;
}

/* Branded ‚ÄúOpen link‚Äù button */
#state-open {
  display: inline-block;
  padding: 10px 16px;
  background-color: var(--understanding);
  color: #0D1B2A;
  font-weight: 700;
  text-decoration: none;
  border-radius: 8px;
  box-shadow: 0 2px 6px var(--shadow);
  transition: transform 0.05s ease, box-shadow 0.2s ease, background-color 0.2s ease;
}
#state-open:hover {
  transform: translateY(-1px);
  box-shadow: 0 4px 10px var(--shadow);
}
#state-open:active {
  transform: translateY(0);
  box-shadow: 0 2px 6px var(--shadow);
}
    .state-deadline .date-value {
    background: #8B0000;
    color: #fff;
    padding: 2px 6px;
    border-radius: 6px;
    font-weight: 700;
  }
    /* üé® Results card font & color overrides */
#zip-output div {
  font-family: 'Playfair Display', serif;   /* Change overall font */
  color: var(--text);                       /* Base color (white) */
  line-height: 1.5;
}

/* Top header line (ZIP ‚Üí State ‚Üí District) */
#zip-output div > div:first-child {
  font-weight: 700;
  font-size: 1.1rem;
  color: var(--understanding);  /* Gold */
  margin-bottom: 6px;
}

/* Status line (Primary / Registration) */
#zip-output .status-line {
  color: var(--text-muted);     /* Muted gray */
  font-size: 0.9rem;
  margin-bottom: 8px;
}

/* Section titles like ‚ÄúU.S. House Race‚Äù */
#zip-output .section-title {
  font-weight: 600;
  color: var(--truth);          /* Green highlight */
  margin-top: 8px;
}

/* Candidate list items */
#zip-output li {
  margin: 4px 0;
  font-size: 0.95rem;
  color: #ffffff;               /* White text */
}
    /* üîó Style the "Open state election page" link */
#zip-output a {
  display: inline-block;
  margin-top: 6px;
  padding: 8px 14px;
  background-color: var(--understanding); /* Gold background */
  color: #0D1B2A;                         /* Deep navy text */
  font-weight: 700;
  text-decoration: none;
  border-radius: 8px;
  box-shadow: 0 2px 6px var(--shadow);
  transition: transform 0.05s ease, box-shadow 0.2s ease, background-color 0.2s ease;
}

#zip-output a:hover {
  transform: translateY(-1px);
  box-shadow: 0 4px 10px var(--shadow);
}

#zip-output a:active {
  transform: translateY(0);
  box-shadow: 0 2px 6px var(--shadow);
}
    /* Primary date text (gold) */
.primary-date {
  color: var(--understanding);   /* your gold */
  font-weight: 700;
}

/* Registration "Deadline" badge (same style as TRUMP tag) */
.deadline-badge {
  margin-left: 6px;
  padding: 2px 6px;
  border-radius: 8px;
  background: #8B0000;  /* dark red */
  color: #fff;
  font-size: 12px;
  font-weight: 700;
}
</style>

<nav class="top-nav">
  <a href="TRUOWL3.html" class="nav-logo">
    <img src="owl_logo_white.png" alt="Owl Logo" onerror="this.style.display='none';" />
    <div class="nav-title">The Strategic Owl</div>
  </a>
  <button class="menu-toggle" id="menuToggle" onclick="toggleMenu()">‚ò∞</button>
  <div class="nav-links" id="mobileMenu">
    <a href="Index.html">Home</a>
    <a href="Dash.html">Dash's</a>
    <a href="TRUOWL3.html">T.R.U. Owl</a>
    <a href="voter_dash.html">Voter Dash</a>
    <a href="strategic-owl-insight-quiz.html">Insight Quiz</a>
    <a href="realitycheck.html">Reality Check</a>
    <a href="the_constitution.html">The Constitution</a>
    <a href="newcontact3.html">Contact</a>
    <a href="https://strategicfretboard.com" target="_blank" rel="noopener noreferrer">Strategic Fretboard</a>
  </div>
</nav>
  <div class="container">
    <h1>Voter Dashboard</h1>
<!-- üéØ Divider -->
    <section class="divider-section">
      <div class="divider-bar">
        <div class="truth"></div>
        <div class="reliability"></div>
        <div class="understanding"></div>
      </div>
      <div class="divider-labels">
        <span>Truth</span>
        <span>Reliability</span>
        <span>Understanding</span>
      </div>
    </section>
    <p>Pick your state to register and see your primary date.</p>
    <select id="state-select">
  <option value="">Select Your State:</option>
</select>

<div id="state-output" class="state-output">
  <input id="state-url" readonly />
  <div id="state-date" class="state-date"></div>
  <div id="state-deadline" class="state-deadline"></div>
  <div class="state-actions">
    <a id="state-open" href="#" target="_blank" rel="noopener">Open link</a>
  </div>
</div>
    <p>Enter your ZIP to see candidates in your districts or verify your rep on House.gov.</p>
 <div class="zip-lookup" style="margin-top:20px; text-align:center;">
  <label for="zip-input" style="display:block; font-weight:600; margin-bottom:6px;">Check My Ballot</label>
  <div style="display:flex; gap:8px; max-width:420px; margin:0 auto; justify-content:center;">
    <input id="zip-input" type="text" inputmode="numeric" pattern="[0-9]*" placeholder="Enter ZIP (e.g., 85301)" style="flex:1; padding:10px; border:1px solid #D4AF37; border-radius:10px;">
    <button id="zip-go" style="padding:10px 14px; border:1px solid #D4AF37; border-radius:10px; background:#0B1C3D; color:#fff;">Trump Check</button>
    <button id="zip-validate" style="padding:10px 14px; border:1px solid #D4AF37; border-radius:10px; background:#0B1C3D; color:#fff;">Verify My Rep</button>
  </div>
</div>

<div id="zip-output" style="display:none; margin-top:14px;"></div>

     <!-- üéØ Divider -->
    <section class="divider-section">
      <div class="divider-bar">
        <div class="truth"></div>
        <div class="reliability"></div>
        <div class="understanding"></div>
      </div>
      <div class="divider-labels">
        <span>Truth</span>
        <span>Reliability</span>
        <span>Understanding</span>
      </div>
    </section>
  </div>
  </div>
  <!-- üìú Footer -->
  <footer style="text-align: center; padding: 24px 12px; font-size: 12px; color: #D4AF37; text-shadow: 0 0 6px rgba(0,0,0,0.6);">
    ¬© 2025 The Strategic Owl. All rights reserved. This platform is protected under U.S. copyright and constitutional law. Unauthorized use, duplication, or distortion of content is prohibited. Created by Taylor Irby ‚Äî designed for clarity, built for truth.
  </footer>

<script>
  // --- CONFIG (yours, unchanged) ---
  const API_KEY  = "AIzaSyCzuh9HBfe0r70r9U35Pe406PPZ-tz6I78";
  const SHEET_ID = "19wBEj9hEkvIyQcoR5E_mBGVAxTzMnddMxk8nuQLAumA";
  // Tab: "State Elections", Range: A2:D51  (A = URL, B = State, C = Upcoming Election Date, D = Registration Deadline)
  const RAW_RANGE = "'State Elections'!A2:D51";
  const RANGE = encodeURIComponent(RAW_RANGE);

  // State -> { url, date } map
  let stateMetaMap = {};

  async function fetchStateLinks() {
    const url = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${RANGE}?key=${API_KEY}`;
    try {
      const res = await fetch(url);
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const json = await res.json();
      const rows = json.values || [];

      // Build map: Column B (state) -> { url: Column A, date: Column C, regDeadline: Column D }
      stateMetaMap = {};
      for (const row of rows) {
        const url = (row[0] || "").trim();
        const state = (row[1] || "").trim();
        const dateRaw = (row[2] || "").trim();
        const regRaw  = (row[3] || "").trim(); // Registration deadline (col D)
        if (state && url) stateMetaMap[state] = { url, date: dateRaw, regDeadline: regRaw }; // last-one-wins
      }

      populateStateDropdown();
    } catch (e) {
      console.error("Failed to fetch State Elections data:", e);
    }
  }

  function populateStateDropdown() {
    const sel = document.getElementById("state-select");
    // Clear but keep placeholder
    sel.innerHTML = '<option value="">Select Your State:</option>';
    const states = Object.keys(stateMetaMap).sort((a, b) => a.localeCompare(b));
    for (const state of states) {
      const opt = document.createElement("option");
      opt.value = state;
      opt.textContent = state;
      sel.appendChild(opt);
    }
    sel.disabled = states.length === 0;
  }

  function handleStateChange(e) {
    const state = e.target.value;
    const meta = stateMetaMap[state];
    const link = meta && meta.url;
    const dateStr = meta && meta.date;
    const regStr  = meta && meta.regDeadline;

    const outWrap = document.getElementById("state-output");
    const urlInput = document.getElementById("state-url");
    const openA = document.getElementById("state-open");
    const dateEl = document.getElementById("state-date");
    const regEl  = document.getElementById("state-deadline");

    if (!state || !link) {
      outWrap.style.display = "none";
      urlInput.value = "";
      openA.href = "#";
      if (dateEl) { dateEl.innerHTML = ""; }
      if (regEl) { regEl.innerHTML = ""; }
      return;
    }

    // Show + update
    urlInput.value = link;
    openA.href = link;

    // Render date if available
    if (dateEl) {
      if (dateStr) {
        dateEl.innerHTML = `<span class="date-label">Primary Election:</span> <strong class="date-value">${formatDate(dateStr)}</strong>`;
      } else {
        dateEl.innerHTML = "";
      }
    }

    // Render registration deadline if available
    if (regEl) {
      regEl.innerHTML = regStr
        ? `<span class="date-label">Registration Deadline:</span> <strong class="date-value">${formatDate(regStr)}</strong>`
        : "";
    }

    outWrap.style.display = "block";

    // OPTIONAL: auto-open in a new tab on selection
    // window.open(link, "_blank", "noopener");
  }

  function formatDate(input) {
    const d = new Date(input);
    if (!isNaN(d.getTime())) {
      return d.toLocaleDateString('en-US', {
        weekday: 'short', month: 'short', day: 'numeric', year: 'numeric'
      });
    }
    return input; // fallback if sheet already has human-readable text
  }

  // ============================================================
  // ========== NEW: ZIP ‚Üí DISTRICT + CANDIDATES ================
  // ============================================================

  // Ranges from your screenshots:
  //  - State Elections roster: AH (State full), AI (Position), AJ (Name), AK (District like "AZ-2" or "AK-AtLarge")
  //  - District2Zipcode map:   A (ZIP), C (State abbr), F (District number)
  const RANGE_ROSTER   = encodeURIComponent("'State Elections'!AH1:AL1000");
  const RANGE_ZIPMAP   = encodeURIComponent("'District2Zipcode'!A1:F46654");

  // State -> [{ position, name, district }]
  let stateRosterMap = {};
  // ZIP -> [{ stateAbbr, districtNum }]
  let zipToSD = {};

  // Two-letter ‚Üí full state name (to align C=abbr with AH=full)
  const STATE_ABBR_TO_NAME = {
    AL:"Alabama", AK:"Alaska", AZ:"Arizona", AR:"Arkansas", CA:"California", CO:"Colorado",
    CT:"Connecticut", DE:"Delaware", FL:"Florida", GA:"Georgia", HI:"Hawaii", ID:"Idaho",
    IL:"Illinois", IN:"Indiana", IA:"Iowa", KS:"Kansas", KY:"Kentucky", LA:"Louisiana",
    ME:"Maine", MD:"Maryland", MA:"Massachusetts", MI:"Michigan", MN:"Minnesota",
    MS:"Mississippi", MO:"Missouri", MT:"Montana", NE:"Nebraska", NV:"Nevada",
    NH:"New Hampshire", NJ:"New Jersey", NM:"New Mexico", NY:"New York",
    NC:"North Carolina", ND:"North Dakota", OH:"Ohio", OK:"Oklahoma", OR:"Oregon",
    PA:"Pennsylvania", RI:"Rhode Island", SC:"South Carolina", SD:"South Dakota",
    TN:"Tennessee", TX:"Texas", UT:"Utah", VT:"Vermont", VA:"Virginia",
    WA:"Washington", WV:"West Virginia", WI:"Wisconsin", WY:"Wyoming", DC:"District of Columbia",
  };

  // Fetch roster + zip map (kept separate so your original fetch stays intact)
  async function fetchZipAndRoster() {
    const url = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values:batchGet` +
                `?ranges=${RANGE_ROSTER}&ranges=${RANGE_ZIPMAP}&key=${API_KEY}`;
    try {
      const res = await fetch(url);
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const json = await res.json();
      const v = json.valueRanges || [];

      // 1) Roster (AH:AL)
      const rosterRows = (v[0] && v[0].values) || [];
      stateRosterMap = {};
      for (let i = 0; i < rosterRows.length; i++) {
        const r = rosterRows[i];
        const stFull   = (r[0] || "").trim(); // AH = full state name
        const position = (r[1] || "").trim(); // AI
        const name     = (r[2] || "").trim(); // AJ
        const district = (r[3] || "").trim(); // AK (e.g., "AZ-2", "AK-AtLarge")
        const aligned  = (r[4] || "").trim(); // AL = Trump Aligned (Yes/No)
        if (!stFull || /^state$/i.test(stFull)) continue; // skip header
        (stateRosterMap[stFull] ||= []).push({ position, name, district, aligned });
      }

      // 2) ZIP map (A:F) using C (abbr) + F (district number)
      const zipRows = (v[1] && v[1].values) || [];
      zipToSD = {};
      for (let i = 0; i < zipRows.length; i++) {
        const r = zipRows[i];
        const zip        = (r[0] || "").trim(); // A
        const stateAbbr  = (r[2] || "").trim(); // C = state abbr (AZ)
        const districtNo = (r[5] || "").trim(); // F = number (1..)
        if (!zip || /^zip$/i.test(zip)) continue; // skip header
        if (stateAbbr && districtNo) {
          (zipToSD[zip] ||= []).push({ stateAbbr, districtNum: districtNo });
        }
      }
    } catch (err) {
      console.error("Failed to fetch roster/zip data:", err);
    }
  }

  // Simple, brand-friendly results
  function handleZipLookup() {
    const input = document.getElementById("zip-input");
    const out   = document.getElementById("zip-output");
    if (!input || !out) return;

    const zip = String(input.value || "").replace(/\D/g, "");
    if (!zip) { out.style.display = "none"; out.innerHTML = ""; return; }

    const hits = zipToSD[zip] || [];
    if (hits.length === 0) {
      out.style.display = "";
      out.innerHTML = `<div style="border:1px solid #D4AF37;border-radius:12px;padding:14px;">
        <strong>No match</strong> for ZIP ${escapeHtml(zip)}. Some ZIP codes span multiple districts‚Äîtry a 9-digit ZIP if you have it.
      </div>`;
      return;
    }

    // dedupe (stateAbbr|districtNum)
    const seen = new Set();
    const uniq = hits.filter(h => {
      const k = `${h.stateAbbr}|${h.districtNum}`;
      if (seen.has(k)) return false;
      seen.add(k);
      return true;
    });

    out.style.display = "";
    out.innerHTML = renderCombinedCard(zip, uniq);
  }

  function renderDistrictCard(zip, abbr, num) {
    const full = STATE_ABBR_TO_NAME[abbr.toUpperCase()] || abbr;
    const roster = stateRosterMap[full] || [];
    const meta   = stateMetaMap[full] || {};
    const primary = meta.date ? ` (Primary: ${formatDate(meta.date)})` : "";

    // House for this district
    const house = roster.filter(r =>
      /U\.?S\.?\s*House/i.test(r.position) && districtMatches(r.district, abbr, num)
    );
    // Statewide
    const senate   = roster.filter(r => /U\.?S\.?\s*Senate/i.test(r.position));
    const governor = roster.filter(r => /Governor/i.test(r.position));

    return `
      <div style="border:1px solid #D4AF37;border-radius:12px;padding:16px;margin:12px 0;background:#0B1C3D10;">
        <div style="font-weight:700;margin-bottom:6px;">ZIP ${escapeHtml(zip)} ‚Üí ${escapeHtml(full)} ‚Ä¢ District ${escapeHtml(num)} <span style="opacity:.7">${primary}</span></div>
        ${renderList("U.S. House Race", house,   (c)=> liCandidate(c))}
        ${renderList("U.S. Senate Race",  senate,  (c)=> liCandidate(c))}
        ${renderList("Governor's Race",     governor,(c)=> liCandidate(c))}
        ${meta.url ? `<div style="margin-top:8px;"><a href="${meta.url}" target="_blank" rel="noopener">Register to Vote in ${escapeHtml(full)}</a></div>` : ""}
      </div>
    `;
  }

  function districtMatches(cell, abbr, num) {
    if (!cell) return false;
    const v = String(cell).trim().toUpperCase();
    const target = `${abbr.toUpperCase()}-${String(num).trim()}`; // e.g., AZ-2
    if (v === target) return true;
    if (v.endsWith(`-${String(num).trim()}`)) return true;       // handles stray prefixes
    // Handle AtLarge case when sheet uses AK-AtLarge but ZIP says "1"
    if (String(num).trim() === "1" && v === `${abbr.toUpperCase()}-ATLARGE`) return true;
    return false;
  }

  function renderList(title, rows, fmt) {
    if (!rows || rows.length === 0) {
      return `<div style="margin:8px 0;"><div style="font-weight:600;">${title}</div><div style="opacity:.75;">No entries yet.</div></div>`;
    }
    return `<div style="margin:8px 0;">
      <div style="font-weight:600;">${title}</div>
      <ul style="margin:6px 0 0 18px;padding:0;">${rows.map(fmt).join("")}</ul>
    </div>`;
  }

  function li(name, position, extra) {
    const x = extra ? ` ‚Äî <span style="opacity:.8;">${escapeHtml(extra)}</span>` : "";
    return `<li>${escapeHtml(name)} <span style="opacity:.8;">(${escapeHtml(position)})</span>${x}</li>`;
  }

  function isTrumpAligned(v) {
    if (v == null) return false;
    const s = String(v).trim().toLowerCase();
    return s === "yes" || s === "y" || s === "true" || s === "1";
  }

  function liCandidate(c) {
    const extra = c.district ? ` ‚Äî <span style="opacity:.8;">${escapeHtml(c.district)}</span>` : "";
    const badge = isTrumpAligned(c.aligned)
      ? ` <span title="Trump-aligned" style="margin-left:6px; padding:2px 6px; border-radius:8px; background:#8B0000; color:#fff; font-size:12px; font-weight:700;">TRUMP</span>`
      : "";
    return `<li>${escapeHtml(c.name)} <span style="opacity:.8;">(${escapeHtml(c.position)})</span>${extra}${badge}</li>`;
  }

  function escapeHtml(s) {
    return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  }

  // ---------- NEW HELPERS FOR CONSOLIDATED CARD ----------
  function sortByFirstName(a, b) {
    return String(a.name || "").localeCompare(String(b.name || ""), undefined, { sensitivity: "base" });
  }

  function candidateIsInAnyDistrict(candidateDistrict, hits) {
    if (!candidateDistrict) return false;
    const cd = String(candidateDistrict).trim().toUpperCase();
    for (const h of hits) {
      const ab = String(h.stateAbbr || "").toUpperCase();
      const dn = String(h.districtNum || "").trim();
      if (!ab || !dn) continue;
      const target = `${ab}-${dn}`;
      if (cd === target || cd.endsWith(`-${dn}`)) return true;
      if (dn === "1" && cd === `${ab}-ATLARGE`) return true; // handle AtLarge mapped to "1"
    }
    return false;
  }

  function renderCombinedCard(zip, hits) {
    // assume all hits are same state; take first for state lookup
    const first = hits[0] || {};
    const abbr = (first.stateAbbr || "").toUpperCase();
    const full = STATE_ABBR_TO_NAME[abbr] || abbr;

    const roster = stateRosterMap[full] || [];
    const meta   = stateMetaMap[full] || {};
    const primaryText = meta.date
  ? `Primary: <span class="primary-date">${formatDate(meta.date)}</span>`
  : "";

const deadlineText = meta.regDeadline
  ? `Registration Deadline: <span class="deadline-badge">${formatDate(meta.regDeadline)}</span>`
  : "";
  
const statusLine = [primaryText, deadlineText].filter(Boolean).join(" ‚Ä¢ ");

    // district string like "3, 4, 6"
    const districtNums = [...new Set(hits.map(h => String(h.districtNum).trim()))].filter(Boolean);
    const districtsStr = districtNums.join(", ");

    // collect candidates
    const house = roster
      .filter(r => /U\.?S\.?\s*House/i.test(r.position) && candidateIsInAnyDistrict(r.district, hits))
      .sort(sortByFirstName);
    const senate = roster
      .filter(r => /U\.?S\.?\s*Senate/i.test(r.position))
      .sort(sortByFirstName);
    const governor = roster
      .filter(r => /Governor/i.test(r.position))
      .sort(sortByFirstName);

    return `
      <div style="border:1px solid #D4AF37;border-radius:12px;padding:16px;margin:12px 0;background:#0B1C3D10;">
        <div style="font-weight:700;margin-bottom:6px;">
          ZIP ${escapeHtml(zip)} ‚Üí ${escapeHtml(full)} ‚Ä¢ District${districtNums.length > 1 ? "s" : ""} ${escapeHtml(districtsStr)}
        </div>
        ${statusLine ? `<div style="opacity:.7; margin-bottom:6px;">${statusLine}</div>` : ""}
        ${renderList("U.S. House Race", house, (c)=> liCandidate(c))}
        ${renderList("U.S. Senate Race",  senate,  (c)=> liCandidate(c))}
        ${renderList("Governor's Race",     governor,(c)=> liCandidate(c))}
        ${meta.url ? `<div style="margin-top:8px;"><a href="${meta.url}" target="_blank" rel="noopener">Open ${escapeHtml(full)} election page</a></div>` : ""}
      </div>
    `;
  }

  // --- INIT (kept your calls; added our fetch + listeners) ---
document.addEventListener("DOMContentLoaded", () => {
  // Yours:
  fetchStateLinks();
  const stateSel = document.getElementById("state-select");
  if (stateSel) stateSel.addEventListener("change", handleStateChange);

  // New:
  fetchZipAndRoster();

  const zipBtn = document.getElementById("zip-go");
  const zipInput = document.getElementById("zip-input");
  const zipValidateBtn = document.getElementById("zip-validate"); // <-- new

  if (zipBtn) zipBtn.addEventListener("click", handleZipLookup);
  if (zipInput) {
    zipInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter") handleZipLookup();
    });
  }
  if (zipValidateBtn) {
    // openHouseLookupFromZip() must be defined (see previous snippet)
    zipValidateBtn.addEventListener("click", openHouseLookupFromZip);
  }
});
  // --- ZIP ‚Üí House lookup helpers ---
function buildZipForHouse(raw) {
  let z = String(raw || "").trim();
  // keep digits and optional dash
  z = z.replace(/[^\d-]/g, "");
  // if 9 straight digits, convert to ZIP+4 with dash
  if (/^\d{9}$/.test(z)) z = z.slice(0,5) + "-" + z.slice(5);
  // must be 5-digit or 5+4
  if (!/^\d{5}(-\d{4})?$/.test(z)) return null;
  return z;
}

function openHouseLookupFromZip() {
  const input = document.getElementById("zip-input");
  const raw = input ? input.value : "";
  const z = buildZipForHouse(raw);
  if (!z) {
    alert("Please enter a valid 5-digit ZIP or ZIP+4 (e.g., 02115 or 02115-1234).");
    return;
  }
  const url = "https://ziplook.house.gov/htbin/findrep_house?ZIP=" + encodeURIComponent(z);
  window.open(url, "_blank", "noopener,noreferrer");
}
</script>

</body>
</html>
