<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>T.R.U. OWL Viewer</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet" />
  <style>
    body {
      background-color: #0D1B2A;
      color: #FFFFFF;
      font-family: 'Inter', sans-serif;
      padding: 20px;
    }

    select {
      margin: 10px 10px 20px 0;
      padding: 5px 10px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }

    th, td {
      padding: 12px;
      border: 1px solid #444;
      text-align: center;
    }

    .text-truth { color: #28A745; font-weight: bold; }
    .text-reliability { color: #3B6CED; font-weight: bold; }
    .text-understanding { color: #D4AF37; font-weight: bold; }

    .positive-score { color: #4FDBA6; font-weight: bold; }
    .negative-score { color: #FF6B6B; font-weight: bold; }

    .score-bar {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }

    .bar-indicator {
      width: 14px;
      height: 14px;
      border-radius: 7px;
    }

    .bar-green {
      background-color: #4FDBA6;
    }

    .bar-red {
      background-color: #FF6B6B;
    }

    .total-score {
      background-color: #1A2B4C;
    }
  </style>
</head>
<body>

  <h1>T.R.U. OWL Score Viewer</h1>

  <select id="role-filter"></select>
  <select id="person-select"></select>

  <table id="score-table" style="display: none;">
    <thead>
      <tr>
        <th>Category</th>
        <th>Score</th>
        <th>Explanation</th>
      </tr>
    </thead>
    <tbody id="score-body"></tbody>
  </table>

  <div id="total-score-box" style="display: none;">
    <p id="total-score-comment"></p>
  </div>

  <script>
    const TRU_MULTIPLIERS = {
      5: { truth: 4.0, reliability: 4.0, understanding: 5.0 },
      4: { truth: 3.5, reliability: 3.5, understanding: 4.5 },
      3: { truth: 3.0, reliability: 3.0, understanding: 4.0 },
      2: { truth: 3.0, reliability: 3.0, understanding: 4.0 },
      1: { truth: 1.3, reliability: 1.3, understanding: 2.0 },
      0: { truth: 1.0, reliability: 1.0, understanding: 2.0 },
    };

    let rowMap = {};
    let roleMap = {};

    async function fetchTRUData() {
      const API_KEY = "AIzaSyCzuh9HBfe0r70r9U35Pe406PPZ-tz6I78";
      const SHEET_ID = "19wBEj9hEkvIyQcoR5E_mBGVAxTzMnddMxk8nuQLAumA";
      const RANGE = "TRU!A2:K1000";
      const url = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${RANGE}?key=${API_KEY}`;
      try {
        const res = await fetch(url);
        if (!res.ok) throw new Error(`HTTP error! Status: ${res.status}`);
        const json = await res.json();
        return json.values || [];
      } catch (err) {
        console.error("Failed to fetch sheet data", err);
        return [];
      }
    }

    function populateDropdowns(data) {
      rowMap = {};
      roleMap = {};

      data.forEach(row => {
        const name = row[0];
        const role = row[1] || "Uncategorized";
        if (!roleMap[role]) roleMap[role] = [];
        roleMap[role].push(name);
        if (name) rowMap[name] = row;
      });

      const roleSelect = document.getElementById("role-filter");
      roleSelect.innerHTML = '<option value="All">All</option>';
      Object.keys(roleMap).sort().forEach(role => {
        const opt = document.createElement("option");
        opt.value = role;
        opt.textContent = role;
        roleSelect.appendChild(opt);
      });

      updatePersonDropdown("All");
    }

    function updatePersonDropdown(role) {
      const personSelect = document.getElementById("person-select");
      personSelect.innerHTML = '<option value="">-- Choose a name --</option>';

      let names = [];

      if (role === "All") {
        names = Object.keys(rowMap);
      } else if (roleMap[role]) {
        names = roleMap[role];
      }

      names.sort().forEach(name => {
        const opt = document.createElement("option");
        opt.value = name;
        opt.textContent = name;
        personSelect.appendChild(opt);
      });

      personSelect.disabled = names.length === 0;
    }

    function showScores() {
      const select = document.getElementById("person-select");
      const table = document.getElementById("score-table");
      const tbody = document.getElementById("score-body");
      const totalBox = document.getElementById("total-score-box");
      const totalCommentEl = document.getElementById("total-score-comment");

      const selected = select.value;
      if (!selected || !rowMap[selected]) {
        table.style.display = "none";
        if (totalBox) totalBox.style.display = "none";
        return;
      }

      const row = rowMap[selected];
      tbody.innerHTML = "";

      const truthRaw = parseFloat(row[2]) || 0;
      const reliabilityRaw = parseFloat(row[3]) || 0;
      const understandingRaw = parseFloat(row[4]) || 0;

      const commentTruth = row[5] || "";
      const commentReliability = row[6] || "";
      const commentUnderstanding = row[7] || "";
      const summaryBelowTable = row[8] || "";
      const totalScoreComment = row[9] || "Summary not available";
      const roleFlag = parseInt(row[10]) || 0;

      const multiplier = TRU_MULTIPLIERS[roleFlag] || TRU_MULTIPLIERS[0];

      const truthFinal = truthRaw * multiplier.truth;
      const reliabilityFinal = reliabilityRaw * multiplier.reliability;
      const understandingFinal = understandingRaw * multiplier.understanding;

      const scores = [
        { label: "Truth", value: truthFinal, raw: truthRaw, mult: multiplier.truth, comment: commentTruth, className: "text-truth" },
        { label: "Reliability", value: reliabilityFinal, raw: reliabilityRaw, mult: multiplier.reliability, comment: commentReliability, className: "text-reliability" },
        { label: "Understanding", value: understandingFinal, raw: understandingRaw, mult: multiplier.understanding, comment: commentUnderstanding, className: "text-understanding" },
      ];

      let total = 0;
      scores.forEach(({ label, value, comment, className }) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td class="${className}">${label}</td>
          <td class="${className}">${value >= 0 ? "+" : ""}${value.toFixed(0)}</td>
          <td>${comment}</td>`;
        tbody.appendChild(tr);
        total += value;
      });

      const lowerSummary = summaryBelowTable.toLowerCase();
      const isPositive = /credible|strong|accurate|well-informed|trusted/.test(lowerSummary);
      const barClass = isPositive ? "bar-green" : "bar-red";

      const totalRow = document.createElement("tr");
      totalRow.innerHTML = `
        <td class="total-score"><strong>Total Score</strong></td>
        <td class="total-score ${total >= 0 ? "positive-score" : "negative-score"}">
          <strong>${total >= 0 ? "+" : ""}${total.toFixed(0)}</strong>
        </td>
        <td class="total-score">
          <div class="score-bar">
            <div class="bar-indicator ${barClass}"></div>
            <span style="color: white;"><strong>${totalScoreComment}</strong></span>
          </div>
        </td>`;
      tbody.appendChild(totalRow);

      table.style.display = "table";
      if (totalBox && totalCommentEl) {
        totalCommentEl.textContent = summaryBelowTable;
        totalBox.style.display = "block";
      }
    }

    document.addEventListener("DOMContentLoaded", async () => {
      const data = await fetchTRUData();
      populateDropdowns(data);

      document.getElementById("role-filter").addEventListener("change", e => {
        updatePersonDropdown(e.target.value);
      });

      document.getElementById("person-select").addEventListener("change", showScores);
    });
  </script>
</body>
</html>
